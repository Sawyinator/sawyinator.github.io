<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Track Module Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { background: #0a0a0a; color: #64ff4e; font-family: 'Segoe UI', sans-serif; display: flex; margin: 0; height: 100vh; overflow: hidden; }
        #sidebar { width: 300px; background: #111; border-right: 2px solid #052e16; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
        #canvas-container { flex-grow: 1; position: relative; background: radial-gradient(circle, #052e16 0%, #000 100%); }
        h2 { margin-top: 0; color: #64ff4e; text-transform: uppercase; letter-spacing: 2px; }
        .tool-group { margin-bottom: 20px; border-bottom: 1px solid #052e16; padding-bottom: 15px; }
        button { background: #052e16; color: #64ff4e; border: 1px solid #64ff4e; padding: 8px; cursor: pointer; margin: 5px 0; width: 100%; transition: 0.2s; }
        button:hover { background: #64ff4e; color: #052e16; }
        label { display: block; font-size: 12px; margin-top: 10px; opacity: 0.8; }
        input, select { width: 100%; background: #000; border: 1px solid #052e16; color: #64ff4e; padding: 5px; margin-top: 5px; }
        #code-output { position: absolute; bottom: 20px; right: 20px; width: 400px; height: 200px; background: rgba(0,0,0,0.9); border: 1px solid #64ff4e; color: #fff; font-family: monospace; padding: 10px; font-size: 11px; white-space: pre; overflow: auto; display: none; }
        .active-item { border: 1px solid yellow !important; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Creator</h2>
    
    <div class="tool-group">
        <strong>Add Shape</strong>
        <button onclick="addShape('rectangle')">Rectangle (Wall/Ramp)</button>
        <button onclick="addShape('circle')">Circle (Bumper)</button>
        <button onclick="addShape('triangle')">Triangle (Divider)</button>
    </div>

    <div id="inspector" style="display:none;">
        <strong>Properties</strong>
        <label>Name / Label</label>
        <input type="text" id="prop-name" oninput="updateSelected()">
        
        <label>Width / Radius</label>
        <input type="number" id="prop-w" oninput="updateSelected()">
        
        <label>Rotation (deg)</label>
        <input type="number" id="prop-angle" oninput="updateSelected()">

        <label>Behavior</label>
        <select id="prop-behavior" onchange="updateSelected()">
            <option value="static">Static</option>
            <option value="rotate">Constant Rotation</option>
            <option value="oscillate">Oscillate (Left/Right)</option>
        </select>
        
        <label>Speed / Amplitude</label>
        <input type="number" step="0.01" id="prop-speed" oninput="updateSelected()" value="0.05">
        
        <button style="background:#450a0a; color:#ef4444; border-color:#ef4444; margin-top:20px;" onclick="deleteSelected()">Delete Shape</button>
    </div>

    <div style="margin-top:auto;">
        <button onclick="generateCode()" style="background:#64ff4e; color:#052e16; font-weight:bold;">GENERATE CODE</button>
    </div>
</div>

<div id="canvas-container" id="p-container">
    <div id="code-output"></div>
</div>

<script>
    const { Engine, Render, Runner, Bodies, Composite, Body } = Matter;
    const engine = Engine.create();
    const container = document.getElementById('canvas-container');
    
    const render = Render.create({
        element: container,
        engine: engine,
        options: { width: 800, height: 900, wireframes: false, background: 'transparent' }
    });

    Render.run(render);
    Runner.run(Runner.create(), engine);

    let shapes = [];
    let selectedShape = null;

    function addShape(type) {
        let shapeData = {
            id: Date.now(),
            type: type,
            x: 400,
            y: 450,
            w: type === 'circle' ? 40 : 200,
            h: 40,
            angle: 0,
            behavior: 'static',
            speed: 0.05,
            name: type + "_" + (shapes.length + 1)
        };
        shapes.push(shapeData);
        rebuildWorld();
        selectShape(shapeData.id);
    }

    function rebuildWorld() {
        Composite.clear(engine.world);
        shapes.forEach(s => {
            let body;
            const style = { isStatic: true, render: { fillStyle: '#052e16', strokeStyle: '#64ff4e', lineWidth: 4 } };
            
            if(s.type === 'rectangle') body = Bodies.rectangle(s.x, s.y, s.w, s.h, { ...style, angle: s.angle * (Math.PI/180) });
            if(s.type === 'circle') body = Bodies.circle(s.x, s.y, s.w, style);
            if(s.type === 'triangle') body = Bodies.polygon(s.x, s.y, 3, s.w, { ...style, angle: s.angle * (Math.PI/180) });
            
            body.myData = s;
            Composite.add(engine.world, body);
        });
    }

    // Basic Drag and Drop Logic
    let isDragging = false;
    container.addEventListener('mousedown', (e) => {
        const rect = container.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        const clicked = shapes.find(s => Math.abs(s.x - mouseX) < 50 && Math.abs(s.y - mouseY) < 50);
        if(clicked) {
            selectShape(clicked.id);
            isDragging = true;
        } else {
            document.getElementById('inspector').style.display = 'none';
            selectedShape = null;
        }
    });

    container.addEventListener('mousemove', (e) => {
        if(isDragging && selectedShape) {
            const rect = container.getBoundingClientRect();
            selectedShape.x = e.clientX - rect.left;
            selectedShape.y = e.clientY - rect.top;
            rebuildWorld();
            updateInspector();
        }
    });

    window.addEventListener('mouseup', () => isDragging = false);

    function selectShape(id) {
        selectedShape = shapes.find(s => s.id === id);
        document.getElementById('inspector').style.display = 'block';
        updateInspector();
    }

    function updateInspector() {
        document.getElementById('prop-name').value = selectedShape.name;
        document.getElementById('prop-w').value = selectedShape.w;
        document.getElementById('prop-angle').value = selectedShape.angle;
        document.getElementById('prop-behavior').value = selectedShape.behavior;
        document.getElementById('prop-speed').value = selectedShape.speed;
    }

    function updateSelected() {
        if(!selectedShape) return;
        selectedShape.name = document.getElementById('prop-name').value;
        selectedShape.w = parseInt(document.getElementById('prop-w').value);
        selectedShape.angle = parseInt(document.getElementById('prop-angle').value);
        selectedShape.behavior = document.getElementById('prop-behavior').value;
        selectedShape.speed = parseFloat(document.getElementById('prop-speed').value);
        rebuildWorld();
    }

    function deleteSelected() {
        shapes = shapes.filter(s => s.id !== selectedShape.id);
        selectedShape = null;
        document.getElementById('inspector').style.display = 'none';
        rebuildWorld();
    }

    function generateCode() {
        let code = `{\n    name: "Custom Module",\n    create: (world, y, cx) => {\n`;
        code += `        const style = { isStatic: true, render: { fillStyle: '#052e16', strokeStyle: '#64ff4e', lineWidth: 4 } };\n\n`;
        
        shapes.forEach(s => {
            const relX = `cx + (${s.x - 400})`;
            const relY = `y + ${s.y}`;
            
            if(s.type === 'rectangle') {
                code += `        const ${s.name} = Bodies.rectangle(${relX}, ${relY}, ${s.w}, ${s.h}, { ...style, angle: ${s.angle * (Math.PI/180)} });\n`;
            } else if(s.type === 'circle') {
                code += `        const ${s.name} = Bodies.circle(${relX}, ${relY}, ${s.w}, style);\n`;
            } else if(s.type === 'triangle') {
                code += `        const ${s.name} = Bodies.polygon(${relX}, ${relY}, 3, ${s.w}, { ...style, angle: ${s.angle * (Math.PI/180)} });\n`;
            }

            if(s.behavior === 'rotate') {
                code += `        Events.on(engine, 'beforeUpdate', () => Body.setAngularVelocity(${s.name}, ${s.speed}));\n`;
            } else if(s.behavior === 'oscillate') {
                code += `        Events.on(engine, 'beforeUpdate', (e) => {\n`;
                code += `            const newX = ${relX} + Math.sin(e.timestamp * 0.003) * ${s.speed * 100};\n`;
                code += `            Body.setPosition(${s.name}, { x: newX, y: ${relY} });\n`;
                code += `        });\n`;
            }
            code += `        Composite.add(world, ${s.name});\n\n`;
        });

        code += `    }\n}`;
        const output = document.getElementById('code-output');
        output.innerText = code;
        output.style.display = 'block';
    }
</script>
</body>
</html>
